import time
import json
from flask import Flask, request

app = Flask(__name__)


@app.route("/reverse/api/test", methods=['POST', 'GET'])
def test():
    print(f"{request.method=}, {request.args=}, {request.date=}, {request.headers}")

    if request.headers.get("x-token", "") != "jarvis":  # 这个token要跟xray的config.yaml里的token一致
        return {
            "code": 2,
            "data": "Login Required"
        }

    if request.method == 'POST':
        request_body_byte = request.stream.read()

        if request_body_byte:
            request_body = str(request_body_byte)[2:-1] # 实际测试发现, 获取到的body 前面有 b', 后面有 ', 需要去掉
            request_body = json.loads(request_body)

            print(f"{request_body=}")

            groups = request_body['group_to_search']
            units = request_body['units_to_search']

            response = {
                "code": 0,
                "data": [],
            }

            # fake server
            id = 0
            for group in groups:
                for unit in units:
                    response['data'].append({
                        "id": id,
                        "group_id": group,
                        "unit_id": unit,
                        "time_stamp": int(time.time()),
                        "event_source": "internal",
                        "event_type": "dns",
                        # abcdef 是个hash, 这里随便填的, 以server实际收到的请求为准
                        "request": f"i-abcdef-{group}-{unit}-xxxx.jarvis.com",
                        # 这里也是, 要填写实际收到的信息
                        "remote_addr": "127.0.0.1"
                    })
                    id += 1

            return response

    return {
        "code": 0,
        "data": None
    }


if __name__ == "__main__":
    app.run(port=8081, host="0.0.0.0")


